<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Інструменти Google</title>
  <link rel="icon" type="image/x-icon" href="https://gmail24.vercel.app/icon.ico" />
  <style>
    /* VARIABLES */
    :root {
      --primary-color: #dc2625; /* Red-700 */
      --secondary-color: #ffffff;
      --background-color: #f5f5f7; 
      --text-color: #1d1d1f;
      --border-color: #e3e3e3; 
      --shadow-color: rgba(0, 0, 0, 0.05);
      --transition-duration: 0.2s;
    }

    /* BASE STYLES */
    * { 
      box-sizing: border-box; 
      font-family: 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
    }

    body {
      margin: 0;
      padding: 30px 20px;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 10vh;
      line-height: 1.5;
    }

    h2 {
      margin-top: 0;
      font-size: 20px; /* Уменьшен размер заголовка для узких колонок */
      font-weight: 600; 
      text-align: center;
      color: var(--text-color);
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    /* LANGUAGE SELECTOR */
    .lang-selector {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      justify-content: center;
    }

    .lang-selector button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      border: 1px solid var(--border-color);
      background-color: var(--secondary-color);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-color);
      box-shadow: 0 1px 3px var(--shadow-color);
      transition: all var(--transition-duration) ease;
    }

    .lang-selector button:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px var(--shadow-color);
    }
    
    .lang-selector button:active {
      transform: scale(0.98); 
    }

    .lang-selector img {
      width: 20px;
      height: 14px;
      border-radius: 2px;
    }

    /* MAIN CONTENT CONTAINER for Horizontal Layout */
    .tool-container {
        display: flex;
        gap: 20px; /* Расстояние между окнами */
        width: 100%;
        /* Увеличена максимальная ширина для 5 колонок (5*320 + 4*gap) */
        max-width: 1720px; 
        justify-content: center;
        flex-wrap: wrap; /* Позволяет окнам переноситься на новую строку на маленьких экранах */
    }

    /* TOOL CARD (ОКНО) */
    .tool {
      background: var(--secondary-color);
      /* Фиксированная ширина для горизонтального размещения */
      width: 100%; 
      max-width: 320px; 
      margin: 10px 0; /* Убраны вертикальные отступы внутри контейнера */
      padding: 25px; /* Немного уменьшены внутренние отступы */
      border-radius: 18px; 
      box-shadow: 0 4px 12px var(--shadow-color), 0 1px 3px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      transition: transform var(--transition-duration) ease, box-shadow var(--transition-duration) ease; 
    }
    
    .tool:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    /* INPUTS & TEXTAREAS */
    input[type="text"],
    textarea,
    input[type="number"],
    input[type="file"] { /* Добавлен стили для input type="file" */
      padding: 12px 15px; /* Немного уменьшены отступы */
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 15px;
      width: 100%;
      color: var(--text-color);
      background: var(--secondary-color);
      transition: border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
    }
    
    /* Стилизация для поля ввода количества логинов */
    #countInput {
        text-align: center;
    }

    /* Специальный стиль для поля выбора файла, чтобы оно выглядело лучше */
    input[type="file"] {
        padding: 10px 15px;
        cursor: pointer;
    }


    input[type="text"]:focus,
    textarea:focus,
    input[type="number"]:focus { /* Добавлен стили для input type="number" */
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(220, 38, 37, 0.15); 
    }
    
    /* Добавлен стиль для нового поля "Длина логина" */
    #lengthInput {
        text-align: center;
    }

    .error-message {
      color: var(--primary-color);
      font-size: 13px; /* Немного уменьшен размер шрифта */
      margin-top: -10px;
      margin-bottom: 15px;
      font-weight: 500;
    }

    textarea {
      background: #fcfcfc;
      resize: vertical; 
      height: 150px; /* Уменьшена высота по умолчанию */
      min-height: 80px;
    }
    
    /* BUTTONS */
    .button-row {
      display: flex;
      flex-direction: column; /* Кнопки всегда вертикально для узких колонок */
      gap: 8px; 
      margin-bottom: 15px;
    }

    .button-row button {
      flex: 1;
      width: 100%; 
      padding: 14px 12px; /* Отступы для центрирования и удобства */
      text-align: center; 
      font-size: 15px; /* Немного уменьшен размер шрифта */
      font-weight: 600;
      color: var(--secondary-color);
      background: var(--primary-color);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(220, 38, 37, 0.2);
      transition: all var(--transition-duration) ease;
    }
    
    /* Secondary Button Style */
    .button-row button:not(:first-child) {
      background: #e9e9e9; 
      color: var(--text-color);
      box-shadow: none;
    }
    
    /* Стили для кнопок, которые не являются первой в ряду (для генератора логинов) */
    .tool:nth-child(3) .button-row button:first-child { 
        background: var(--primary-color);
        color: var(--secondary-color);
    }
    
    /* Стили для кнопок, которые не являются первой в ряду */
    .tool:nth-child(3) .button-row button:not(:first-child) { 
        background: #e9e9e9;
        color: var(--text-color);
    }
    
    /* Стили для кнопок, которые не являются первой в ряду (для нового укорочителя) */
    .tool:nth-child(4) .button-row button:first-child { 
        background: var(--primary-color);
        color: var(--secondary-color);
    }
    
    .tool:nth-child(4) .button-row button:not(:first-child) { 
        background: #e9e9e9;
        color: var(--text-color);
    }
    
    /* Стили для кнопок, которые не являются первой в ряду (для M3U) */
    .tool:last-child .button-row button:first-child { 
        background: var(--primary-color);
        color: var(--secondary-color);
    }
    
    .tool:last-child .button-row button:not(:first-child) { 
        background: #e9e9e9;
        color: var(--text-color);
    }
    
    
    .button-row button:hover {
      opacity: 0.9;
      transform: translateY(-1px); 
    }
    
    .button-row button:active {
      transform: translateY(1px) scale(0.99); 
      box-shadow: 0 1px 2px rgba(220, 38, 37, 0.2);
    }
    
    /* Secondary Button Hover/Active */
    .button-row button:not(:first-child):hover {
      background: #d8d8d8;
      opacity: 1;
    }
    
    .tool:nth-child(3) .button-row button:not(:first-child):hover,
    .tool:nth-child(4) .button-row button:not(:first-child):hover,
    .tool:last-child .button-row button:not(:first-child):hover {
        background: #d8d8d8;
    }
    

    /* EMAIL COUNTER */
    .email-counter {
      background: #f7f7f9; 
      padding: 10px; /* Немного уменьшен отступ */
      border: 1px solid var(--border-color);
      border-radius: 10px;
      text-align: center;
      font-size: 16px; /* Немного уменьшен размер шрифта */
      font-weight: 700;
      color: var(--primary-color); 
      margin-bottom: 15px;
    }
    
    /* LABEL STYLE */
    .input-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 5px;
    }

    /* TOAST NOTIFICATION STYLES */
    #toastNotification {
      visibility: hidden; /* Скрыто по умолчанию */
      min-width: 250px;
      margin-left: -125px;
      background-color: var(--primary-color);
      color: var(--secondary-color);
      text-align: center;
      border-radius: 10px;
      padding: 16px;
      position: fixed;
      z-index: 10;
      left: 50%;
      bottom: 30px;
      font-size: 17px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: visibility 0s, opacity 0.5s ease;
    }

    /* Класс для показа уведомления */
    #toastNotification.show {
      visibility: visible;
      opacity: 1;
      /* Добавим небольшую анимацию подъема */
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    /* Анимация появления и исчезновения */
    @keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadeout {
      from {bottom: 30px; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }

    /* NEW: Style for the displayed short link */
    .shortener-output-display {
      font-size: 16px;
      font-weight: 700; /* Жирный шрифт */
      color: var(--primary-color); /* Цвет как у кнопки */
      text-align: center; /* Центрирование */
      padding: 15px 0;
      margin-bottom: 15px; /* Отступ от кнопок */
      word-break: break-all; /* Для длинных ссылок */
    }

    /* --- Стили для Модального окна QR-кода --- */
    .modal {
        display: none; /* Скрыто по умолчанию */
        position: fixed;
        z-index: 100; /* Высокий индекс для отображения поверх всего */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7); /* Полупрозрачный фон */
        backdrop-filter: blur(3px);
        -webkit-backdrop-filter: blur(3px);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: var(--secondary-color);
        margin: auto;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 90%;
        width: 400px; /* Фиксированная ширина для QR-кода */
        text-align: center;
        position: relative;
        animation: animatetop 0.4s;
    }

    @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 0; opacity: 1}
    }

    .modal-close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
        cursor: pointer;
        transition: 0.3s;
    }

    .modal-close:hover,
    .modal-close:focus {
        color: var(--primary-color);
        text-decoration: none;
    }

    #qrCodeImage {
        width: 100%; /* Изображение будет занимать всю ширину контейнера */
        max-width: 300px; /* Максимальный размер QR-кода */
        height: auto;
        margin: 20px auto 30px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        display: block;
    }

    /* Стиль для кнопки внутри модального окна (НАПРАВЛЕННОЕ ИЗМЕНЕНИЕ) */
    .modal-button-row {
        display: flex;
        justify-content: center;
    }
    
    .modal-button-row button {
        /* Наследуем базовый стиль основной кнопки */
        flex: unset; /* Отключаем flex: 1, который применен в .button-row button */
        width: 80%;
        padding: 14px 12px;
        font-size: 15px;
        font-weight: 600;
        color: var(--secondary-color);
        background: var(--primary-color);
        border: none;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(220, 38, 37, 0.2);
        transition: all var(--transition-duration) ease;
    }
    
    /* Обеспечиваем стили hover/active для соответствия основной кнопке */
    .modal-button-row button:hover {
      opacity: 0.9;
      transform: translateY(-1px); 
    }
    
    .modal-button-row button:active {
      transform: translateY(1px) scale(0.99); 
      box-shadow: 0 1px 2px rgba(220, 38, 37, 0.2);
    }
    
    /* MEDIA QUERIES - Vertical layout for smaller screens */
    @media (max-width: 1730px) { /* Изменено для 5-х колонок (для 4-х колонок) */
        .tool-container {
            max-width: 1380px; /* 4 колонки */
        }
    }
    @media (max-width: 1390px) { /* Изменено для 4-х колонок (для 3-х колонок) */
        .tool-container {
            max-width: 1040px; /* 3 колонки */
        }
    }
    @media (max-width: 1060px) { /* Изменено для 3-х колонок (для 2-х колонок) */
        .tool-container {
            max-width: 700px; /* 2 колонки */
        }
    }
    
    @media (max-width: 740px) { /* Для 1 колонки */
      .tool-container {
        flex-direction: column;
        gap: 0;
        max-width: 400px; /* Ограничим ширину для лучшего вида на мобильных */
      }
      .tool {
        max-width: 100%; 
        margin: 15px 0;
      }
      .modal-content {
          width: 95%; 
          padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="lang-selector">
    <button onclick="setLanguage('uk')"><img src="https://flagcdn.com/w40/ua.png" alt="UK">UK</button>
    <button onclick="setLanguage('ru')"><img src="https://flagcdn.com/w40/ru.png" alt="RU">RU</button>
    <button onclick="setLanguage('en')"><img src="https://flagcdn.com/w40/us.png" alt="EN">EN</button>
    <button onclick="setLanguage('es')"><img src="https://flagcdn.com/w40/es.png" alt="ES">ES</button>
  </div>
  
  <div class="tool-container">
      <div class="tool">
        <h2 id="driveTitle">Пряма посилання Google Диска</h2>
        <input type="text" id="driveInput" placeholder="Вставьте ссылку на файл в Google Диске">
        
        <div id="driveOutputDisplay" class="shortener-output-display" style="display:none"></div>
        
        <div class="button-row">
          <button onclick="convertDriveLink()" id="convertBtn">Преобразовать</button>
          <button onclick="copyDrive()" id="copyDriveBtn">Скопировать ссылку</button>
          <button onclick="goToDriveLink()" id="goToLinkBtn">Перейти по ссылке</button>
          <button onclick="shortenDriveLink()" id="shortenLinkBtn">Укоротить ссылку</button> 
          <button onclick="generateDriveQr()" id="generateDriveQrBtn">QR Код</button>
        </div>
        <textarea id="driveOutput" placeholder="Прямая ссылка для скачивания" readonly></textarea>
      </div>
      
      <div class="tool">
        <h2 id="gmailTitle">Варіації пошти Gmail</h2>
        <input type="text" id="emailInput" placeholder="Введите Gmail логин или адрес, например dokyt56fg78" oninput="validateEmail()">
        <div id="emailError" class="error-message" style="display:none"></div>
        <div id="emailCounter" class="email-counter">Вариаций: 0</div>
        <div class="button-row">
          <button onclick="generateGmailVariations()" id="generateBtn">Сгенерировать</button>
          <button onclick="copyGmail()" id="copyBtn">Скопировать всё</button>
          <button onclick="downloadTxtBtn" id="downloadTxtBtn">Скачать .txt</button>
          <button onclick="downloadCSV()" id="downloadCsvBtn">Экспорт в CSV</button>
        </div>
        <textarea id="gmailOutput" placeholder="Здесь появятся варианты..." readonly></textarea>
      </div>
      
      <div class="tool">
        <h2 id="loginGenTitle">Генератор логінів Gmail</h2>
        <div class="input-label" id="countLabel">Кількість (1-50):</div>
        <input type="number" id="countInput" value="10" min="1" max="50" oninput="validateCountInput()">
        <div id="loginCountError" class="error-message" style="display:none"></div>
        
        <div class="input-label" id="lengthLabel">Длина логина (6-20):</div>
        <input type="text" id="lengthInput" value="10" min="6" max="20" inputmode="numeric" oninput="validateLengthInput()">
        <div id="loginLengthError" class="error-message" style="display:none"></div>
        
        <div class="button-row">
          <button onclick="generateWordBasedLogins()" id="generateLoginBtn">Сгенерировать</button>
          <button onclick="copyLogins()" id="copyLoginsBtn">Скопировать всё</button>
          <button onclick="downloadLoginsTxt()" id="downloadLoginsTxtBtn">Скачать .txt</button>
        </div>
        <textarea id="loginOutput" placeholder="Здесь появятся короткие логины..." readonly></textarea>
      </div>
      
      <div class="tool">
        <h2 id="shortenerTitle">Укорочувач посилань</h2>
        <input type="text" id="shortenerInput" placeholder="Вставьте длинную ссылку">
        <input type="text" id="customIdInput" placeholder="Кастомный ID (опционально)">
        
        <div id="shortenerOutputDisplay" class="shortener-output-display" style="display:none"></div>
        
        <div class="button-row">
          <button onclick="shortenCustomLink()" id="shortenCustomBtn">Укоротить</button>
          <button onclick="copyShortenedLink()" id="copyShortenedBtn">Скопировать</button>
          <button onclick="generateShortenerQr()" id="generateShortenerQrBtn">QR Код</button>
        </div>
        </div>
        
        <div class="tool">
            <h2 id="m3uTitle">Парсер M3U Плейлистов</h2>
            <div class="input-label" id="m3uFileLabel">Выберите файл .m3u или .m3u8:</div>
            <input type="file" id="m3uFileInput" accept=".m3u,.m3u8" onchange="parseM3UFile()">
            
            <div id="m3uCounter" class="email-counter">Найдено: 0</div>
            
            <div class="button-row">
                <button onclick="copyM3UOutput()" id="copyM3UBtn">Скопировать всё</button>
                <button onclick="downloadM3UOutput()" id="downloadM3UTxtBtn">Скачать .txt</button>
            </div>
            <textarea id="m3uOutput" placeholder="Здесь появятся отсортированные названия каналов..." readonly></textarea>
        </div>
        </div>
  
  <div id="toastNotification">Скопировано!</div>

  <div id="qrCodeModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <span class="modal-close" onclick="closeModal(event)">&times;</span>
      <h3 id="qrModalTitle" style="color:var(--text-color);">QR-код</h3>
      <img id="qrCodeImage" src="" alt="QR Code">
      <div class="modal-button-row">
        <button onclick="downloadQrCode()" id="downloadQrBtn">Сохранить</button>
      </div>
    </div>
  </div>


  <script>
    // --- START: Existing Helper Functions (for XLSX, kept as is) ---
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error(e);
          return "";
        }
      }
      return gk_fileData[filename] || "";
    }
    // --- END: Existing Helper Functions ---

    const translations = {
      ru: {
        gmailTitle: "Вариации почты Gmail",
        generateBtn: "Сгенерировать",
        copyBtn: "Скопировать всё",
        downloadTxtBtn: "Скачать .txt",
        downloadCsvBtn: "Экспорт в CSV",
        driveTitle: "Прямая ссылка Google Диска",
        convertBtn: "Преобразовать",
        copyDriveBtn: "Скопировать ссылку",
        goToLinkBtn: "Перейти по ссылке",
        shortenLinkBtn: "Укоротить ссылку", 
        generateDriveQrBtn: "QR Код", 
        emailCounter: "Вариаций: ",
        emailInputPlaceholder: "Введите Gmail логин или адрес, например dokyt56fg78",
        gmailOutputPlaceholder: "Здесь появятся варианты...",
        driveInputPlaceholder: "Вставьте ссылку на файл в Google Диске",
        driveOutputPlaceholder: "Прямая ссылка для скачивания",
        copySuccess: "Скопировано!",
        copyError: "Ошибка копирования: ",
        invalidEmailError: "Некорректный Gmail логин или адрес",
        noGmailDataError: "Нет данных для сохранения.",
        noGmailExportError: "Нет данных для экспорта.",
        invalidDriveLinkError: "Не удалось извлечь ID файла. Проверьте правильность ссылки.",
        noDriveLinkError: "Нет ссылки для перехода. Сначала преобразуйте ссылку.",
        noLinkToShortenError: "Нет ссылки для укорачивания. Сначала преобразуйте ссылку.", 
        shortenLinkError: "Ошибка при укорачивании ссылки. Проверьте ссылку.", 
        noLinkForQrError: "Нет ссылки для генерации QR-кода. Сначала преобразуйте/введите ссылку.", 
        qrGenerationError: "Ошибка при генерации QR-кода.", 
        qrModalTitle: "QR-код для ссылки", 
        downloadQrBtn: "Сохранить", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ ГЕНЕРАТОРА ЛОГИНОВ
        loginGenTitle: "Генератор логинов Gmail",
        countLabel: "Количество (1-50):",
        lengthLabel: "Длина логина (6-20):", 
        generateLoginBtn: "Сгенерировать",
        copyLoginsBtn: "Скопировать всё",
        downloadLoginsTxtBtn: "Скачать .txt", 
        loginOutputPlaceholder: "Здесь появятся короткие логины...",
        invalidCountError: "Количество должно быть от 1 до 50.",
        invalidLengthError: "Длина должна быть от 6 до 20 символов.", 
        noLoginsToCopyError: "Нет сгенерированных логинов для копирования.",
        noLoginsToSaveError: "Нет сгенерированных логинов для сохранения.", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ УКОРОТИТЕЛЯ
        shortenerTitle: "Укоротитель ссылок",
        shortenCustomBtn: "Укоротить",
        copyShortenedBtn: "Скопировать",
        generateShortenerQrBtn: "QR Код", 
        shortenerInputPlaceholder: "Вставьте длинную ссылку",
        customIdInputPlaceholder: "Кастомный ID (опционально)",
        noLinkToShortenGeneralError: "Введите ссылку для укорачивания.",
        shortenGeneralError: "Ошибка при укорачивании ссылки:",
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ M3U ПАРСЕРА
        m3uTitle: "Парсер M3U Плейлистов",
        m3uFileLabel: "Выберите файл .m3u или .m3u8:",
        m3uCounter: "Найдено: ",
        copyM3UBtn: "Скопировать всё",
        downloadM3UTxtBtn: "Скачать .txt",
        m3uOutputPlaceholder: "Здесь появятся отсортированные названия каналов...",
        noM3UDataError: "Нет данных для сохранения. Сначала загрузите и обработайте файл.",
        m3uReadError: "Ошибка при чтении файла: ",
        noChannelsFound: "Каналы не найдены в плейлисте.",
      },
      en: {
        gmailTitle: "Gmail Address Variations",
        generateBtn: "Generate",
        copyBtn: "Copy All",
        downloadTxtBtn: "Download .txt",
        downloadCsvBtn: "Export to CSV",
        driveTitle: "Direct Google Drive Link",
        convertBtn: "Convert",
        copyDriveBtn: "Copy Link",
        goToLinkBtn: "Go to Link",
        shortenLinkBtn: "Shorten Link", 
        generateDriveQrBtn: "QR Code", 
        emailCounter: "Variations: ",
        emailInputPlaceholder: "Enter Gmail login or address, e.g., dokyt56fg78",
        gmailOutputPlaceholder: "Variations will appear here...",
        driveInputPlaceholder: "Paste the Google Drive file link",
        driveOutputPlaceholder: "Direct download link",
        copySuccess: "Copied!",
        copyError: "Copy error: ",
        invalidEmailError: "Invalid Gmail login or address",
        noGmailDataError: "No data to save.",
        noGmailExportError: "No data to export.",
        invalidDriveLinkError: "Failed to extract file ID. Check the link.",
        noDriveLinkError: "No link to navigate to. Convert the link first.",
        noLinkToShortenError: "No link to shorten. Convert the link first.", 
        shortenLinkError: "Error shortening link. Check the link.", 
        noLinkForQrError: "No link to generate QR code. Convert/enter link first.", 
        qrGenerationError: "Error generating QR code.", 
        qrModalTitle: "QR Code for Link", 
        downloadQrBtn: "Download", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ ГЕНЕРАТОРА ЛОГИНОВ
        loginGenTitle: "Gmail Login Generator",
        countLabel: "Count (1-50):",
        lengthLabel: "Login Length (6-20):", 
        generateLoginBtn: "Generate",
        copyLoginsBtn: "Copy All",
        downloadLoginsTxtBtn: "Download .txt", 
        loginOutputPlaceholder: "Short logins will appear here...",
        invalidCountError: "Count must be between 1 and 50.",
        invalidLengthError: "Length must be between 6 and 20 characters.", 
        noLoginsToCopyError: "No generated logins to copy.",
        noLoginsToSaveError: "No generated logins to save.", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ УКОРОТИТЕЛЯ
        shortenerTitle: "Link Shortener",
        shortenCustomBtn: "Shorten",
        copyShortenedBtn: "Copy",
        generateShortenerQrBtn: "QR Code", 
        shortenerInputPlaceholder: "Paste long link",
        customIdInputPlaceholder: "Custom ID (optional)",
        noLinkToShortenGeneralError: "Enter a link to shorten.",
        shortenGeneralError: "Error shortening link:",
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ M3U ПАРСЕРА
        m3uTitle: "M3U Playlist Parser",
        m3uFileLabel: "Select .m3u or .m3u8 file:",
        m3uCounter: "Found: ",
        copyM3UBtn: "Copy All",
        downloadM3UTxtBtn: "Download .txt",
        m3uOutputPlaceholder: "Sorted channel names will appear here...",
        noM3UDataError: "No data to save. Load and process a file first.",
        m3uReadError: "Error reading file: ",
        noChannelsFound: "No channels found in the playlist.",
      },
      es: {
        gmailTitle: "Variaciones de Gmail",
        generateBtn: "Generar",
        copyBtn: "Copiar todo",
        downloadTxtBtn: "Descargar .txt",
        downloadCsvBtn: "Exportar a CSV",
        driveTitle: "Enlace directo de Google Drive",
        convertBtn: "Convertir",
        copyDriveBtn: "Copiar enlace",
        goToLinkBtn: "Ir al enlace",
        shortenLinkBtn: "Acortar enlace", 
        generateDriveQrBtn: "Código QR", 
        emailCounter: "Variaciones: ",
        emailInputPlaceholder: "Ingrese el login o dirección de Gmail, por ejemplo, dokyt56fg78",
        gmailOutputPlaceholder: "Las variaciones aparecerán aquí...",
        driveInputPlaceholder: "Pegue el enlace del archivo de Google Drive",
        driveOutputPlaceholder: "Enlace de descarga directa",
        copySuccess: "¡Copiado!", 
        copyError: "Error al copiar: ",
        invalidEmailError: "Login o dirección de Gmail no válida",
        noGmailDataError: "No hay datos para guardar.",
        noGmailExportError: "No hay datos para exportar.",
        invalidDriveLinkError: "No se pudo extraer el ID del archivo. Verifique el enlace.",
        noDriveLinkError: "No hay enlace para navegar. Convierta el enlace primero.",
        noLinkToShortenError: "No hay enlace para acortar. Convierta el enlace primero.", 
        shortenLinkError: "Error al acortar el enlace. Verifique el enlace.", 
        noLinkForQrError: "No hay enlace para generar el código QR. Convierta/ingrese el enlace primero.", 
        qrGenerationError: "Error al generar el código QR.", 
        qrModalTitle: "Código QR para Enlace", 
        downloadQrBtn: "Descargar", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ ГЕНЕРАТОРА ЛОГИНОВ
        loginGenTitle: "Generador de Login de Gmail",
        countLabel: "Cantidad (1-50):",
        lengthLabel: "Longitud del Login (6-20):", 
        generateLoginBtn: "Generar",
        copyLoginsBtn: "Copiar todo",
        downloadLoginsTxtBtn: "Descargar .txt", 
        loginOutputPlaceholder: "Los logins cortos aparecerán aquí...",
        invalidCountError: "La cantidad debe estar entre 1 y 50.",
        invalidLengthError: "La longitud debe ser entre 6 и 20 caracteres.", 
        noLoginsToCopyError: "No hay logins generados para copiar.",
        noLoginsToSaveError: "No hay logins generados para guardar.", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ УКОРОТИТЕЛЯ
        shortenerTitle: "Acortador de Enlaces",
        shortenCustomBtn: "Acortar",
        copyShortenedBtn: "Copiar",
        generateShortenerQrBtn: "Código QR", 
        shortenerInputPlaceholder: "Pegue el enlace largo",
        customIdInputPlaceholder: "ID personalizado (opcional)",
        noLinkToShortenGeneralError: "Ingrese un enlace para acortar.",
        shortenGeneralError: "Error al acortar el enlace:",
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ M3U ПАРСЕРА
        m3uTitle: "Analizador de Listas M3U",
        m3uFileLabel: "Seleccione archivo .m3u o .m3u8:",
        m3uCounter: "Encontrado: ",
        copyM3UBtn: "Copiar todo",
        downloadM3UTxtBtn: "Descargar .txt",
        m3uOutputPlaceholder: "Los nombres de canal ordenados aparecerán aquí...",
        noM3UDataError: "No hay datos para guardar. Cargue y procese un archivo primero.",
        m3uReadError: "Error al leer el archivo: ",
        noChannelsFound: "No se encontraron canales en la lista de reproducción.",
      },
      uk: { 
        gmailTitle: "Варіації пошти Gmail",
        generateBtn: "Згенерувати",
        copyBtn: "Скопіювати все",
        downloadTxtBtn: "Завантажити .txt",
        downloadCsvBtn: "Експорт у CSV",
        driveTitle: "Пряме посилання Google Диска",
        convertBtn: "Перетворити",
        copyDriveBtn: "Скопіювати посилання",
        goToLinkBtn: "Перейти за посиланням",
        shortenLinkBtn: "Скоротити посилання", 
        generateDriveQrBtn: "QR Код", 
        emailCounter: "Варіацій: ",
        emailInputPlaceholder: "Введіть логін або адресу Gmail, наприклад dokyt56fg78",
        gmailOutputPlaceholder: "Тут з'являться варіанти...",
        driveInputPlaceholder: "Вставте посилання на файл у Google Диску",
        driveOutputPlaceholder: "Пряме посилання для завантаження",
        copySuccess: "Скопійовано!", 
        copyError: "Помилка копіювання: ",
        invalidEmailError: "Некоректний логін або адреса Gmail",
        noGmailDataError: "Немає даних для збереження.",
        noGmailExportError: "Немає даних для експорту.",
        invalidDriveLinkError: "Не вдалося витягти ID файлу. Перевірте правильність посилання.",
        noDriveLinkError: "Немає посилання для переходу. Спершу перетворіть посилання.",
        noLinkToShortenError: "Немає посилання для скорочення. Спершу перетворіть посилання.", 
        shortenLinkError: "Помилка при скороченні посилання. Перевірте посилання.",
        noLinkForQrError: "Немає посилання для генерації QR-коду. Спершу перетворіть/введіть посилання.", 
        qrGenerationError: "Помилка при генерації QR-коду.",
        qrModalTitle: "QR-код для посилання", 
        downloadQrBtn: "Завантажити", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ ГЕНЕРАТОРА ЛОГИНОВ
        loginGenTitle: "Генератор логінів Gmail",
        countLabel: "Кількість (1-50):",
        lengthLabel: "Довжина логіна (6-20):", 
        generateLoginBtn: "Згенерувати",
        copyLoginsBtn: "Скопіювати все",
        downloadLoginsTxtBtn: "Завантажити .txt", 
        loginOutputPlaceholder: "Тут з'являться короткі логіни...",
        invalidCountError: "Кількість має бути від 1 до 50.",
        invalidLengthError: "Довжина має бути від 6 до 20 символів.", 
        noLoginsToCopyError: "Немає згенерованих логінів для копіювання.",
        noLoginsToSaveError: "Немає згенерованих логінів для збереження.", 
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ УКОРОТИТЕЛЯ
        shortenerTitle: "Укорочувач посилань",
        shortenCustomBtn: "Укоротити",
        copyShortenedBtn: "Скопіювати",
        generateShortenerQrBtn: "QR Код", 
        shortenerInputPlaceholder: "Вставте довге посилання",
        customIdInputPlaceholder: "Кастомний ID (опціонально)",
        noLinkToShortenGeneralError: "Введіть посилання для скорочення.",
        shortenGeneralError: "Помилка при скороченні посилання:",
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ M3U ПАРСЕРА
        m3uTitle: "Парсер M3U Плейлистів",
        m3uFileLabel: "Оберіть файл .m3u або .m3u8:",
        m3uCounter: "Знайдено: ",
        copyM3UBtn: "Скопіювати все",
        downloadM3UTxtBtn: "Завантажити .txt",
        m3uOutputPlaceholder: "Тут з'являться відсортовані назви каналів...",
        noM3UDataError: "Немає даних для збереження. Спершу завантажте та обробіть файл.",
        m3uReadError: "Помилка при читанні файлу: ",
        noChannelsFound: "Канали не знайдено у плейлисті.",
      }
    };

    let toastTimer;

    // ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ УВЕДОМЛЕНИЯ
    function showToast(message) {
        // Очищаем предыдущий таймер, если он есть
        clearTimeout(toastTimer);
        const toast = document.getElementById("toastNotification");
        toast.innerText = message;
        toast.className = "show";
        // Запускаем новый таймер для скрытия
        toastTimer = setTimeout(function(){ 
          toast.className = toast.className.replace("show", ""); 
        }, 3000);
    }


    function setLanguage(lang) {
      document.documentElement.lang = lang;
      const t = translations[lang];
      document.getElementById("gmailTitle").innerText = t.gmailTitle;
      document.getElementById("generateBtn").innerText = t.generateBtn;
      document.getElementById("copyBtn").innerText = t.copyBtn;
      document.getElementById("downloadTxtBtn").innerText = t.downloadTxtBtn;
      document.getElementById("downloadCsvBtn").innerText = t.downloadCsvBtn;
      document.getElementById("driveTitle").innerText = t.driveTitle;
      document.getElementById("convertBtn").innerText = t.convertBtn;
      document.getElementById("copyDriveBtn").innerText = t.copyDriveBtn;
      document.getElementById("goToLinkBtn").innerText = t.goToLinkBtn;
      document.getElementById("shortenLinkBtn").innerText = t.shortenLinkBtn; 
      document.getElementById("generateDriveQrBtn").innerText = t.generateDriveQrBtn; 
      document.getElementById("qrModalTitle").innerText = t.qrModalTitle; 
      document.getElementById("downloadQrBtn").innerText = t.downloadQrBtn; 
      const currentCount = document.getElementById("gmailOutput").value.split('\n').filter(Boolean).length;
      document.getElementById("emailCounter").innerText = t.emailCounter + currentCount;
      document.getElementById("emailInput").placeholder = t.emailInputPlaceholder;
      document.getElementById("gmailOutput").placeholder = t.gmailOutputPlaceholder;
      document.getElementById("driveInput").placeholder = t.driveInputPlaceholder;
      document.getElementById("driveOutput").placeholder = t.driveOutputPlaceholder;
      document.getElementById("toastNotification").innerText = t.copySuccess; 
      
      // ОБНОВЛЕНИЕ ДЛЯ ГЕНЕРАТОРА ЛОГИНОВ
      document.getElementById("loginGenTitle").innerText = t.loginGenTitle;
      document.getElementById("countLabel").innerText = t.countLabel;
      document.getElementById("lengthLabel").innerText = t.lengthLabel;
      document.getElementById("generateLoginBtn").innerText = t.generateLoginBtn;
      document.getElementById("copyLoginsBtn").innerText = t.copyLoginsBtn;
      document.getElementById("downloadLoginsTxtBtn").innerText = t.downloadLoginsTxtBtn; 
      document.getElementById("loginOutput").placeholder = t.loginOutputPlaceholder;
      
      // ОБНОВЛЕНИЕ ДЛЯ НОВОГО УКОРОТИТЕЛЯ
      document.getElementById("shortenerTitle").innerText = t.shortenerTitle;
      document.getElementById("shortenCustomBtn").innerText = t.shortenCustomBtn;
      document.getElementById("copyShortenedBtn").innerText = t.copyShortenedBtn;
      document.getElementById("generateShortenerQrBtn").innerText = t.generateShortenerQrBtn; 
      document.getElementById("shortenerInput").placeholder = t.shortenerInputPlaceholder;
      document.getElementById("customIdInput").placeholder = t.customIdInputPlaceholder;
      
      // ОБНОВЛЕНИЕ ДЛЯ M3U ПАРСЕРА
      document.getElementById("m3uTitle").innerText = t.m3uTitle;
      document.getElementById("m3uFileLabel").innerText = t.m3uFileLabel;
      document.getElementById("copyM3UBtn").innerText = t.copyM3UBtn;
      document.getElementById("downloadM3UTxtBtn").innerText = t.downloadM3UTxtBtn;
      document.getElementById("m3uOutput").placeholder = t.m3uOutputPlaceholder;
      // Обновление счетчика для M3U
      const currentM3UCount = document.getElementById("m3uOutput").value.split('\n').filter(Boolean).length;
      document.getElementById("m3uCounter").innerText = t.m3uCounter + currentM3UCount;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        setLanguage('uk');
    });

    async function copyToClipboard(text) {
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      try {
        await navigator.clipboard.writeText(text);
        showToast(t.copySuccess); 
      } catch (err) {
        alert(t.copyError + err);
      }
    }
    
    // --- ИЗМЕНЕННАЯ ФУНКЦИЯ validateEmail() ---
    function validateEmail() {
      const emailField = document.getElementById("emailInput");
      const errorField = document.getElementById("emailError");
      const input = emailField.value.trim().toLowerCase();
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      
      if (!input) {
          emailField.classList.remove("invalid");
          errorField.style.display = "none";
          return;
      }

      // Если введен полный email, проверяем его.
      // Если введен только логин (нет @), проверяем только логин.
      const isFullEmail = input.includes('@');
      let localPart;
      
      if (isFullEmail) {
          // Проверяем формат полного адреса (user@gmail.com)
          const fullEmailRegex = /^([a-z0-9]+(\.?[a-z0-9]+)*)@(gmail|googlemail)\.com$/;
          if (!fullEmailRegex.test(input)) {
              localPart = ""; // Некорректный адрес
          } else {
              localPart = input.split("@")[0];
          }
      } else {
          // Проверяем формат логина (только a-z, 0-9 и точка)
          const loginRegex = /^[a-z0-9]+(\.?[a-z0-9]+)*$/;
          if (!loginRegex.test(input)) {
              localPart = ""; // Некорректный логин
          } else {
              localPart = input;
          }
      }

      // Дополнительные правила Gmail: не начинается/заканчивается точкой, нет двойных точек.
      // Также проверяем минимальную длину - 6 символов
      const isValidLocalPart = localPart && localPart.length >= 6 && /^(?!\.).*(?<!\.)$/.test(localPart) && !localPart.includes("..");
      const isValid = isFullEmail ? (localPart && isValidLocalPart) : (localPart && isValidLocalPart);
      
      if (!isValid) {
        emailField.classList.add("invalid");
        errorField.style.display = "block";
        errorField.innerText = t.invalidEmailError;
      } else {
        emailField.classList.remove("invalid");
        errorField.style.display = "none";
      }
    }
    // --- КОНЕЦ ИЗМЕНЕННОЙ ФУНКЦИИ validateEmail() ---

    // --- ИЗМЕНЕННАЯ ФУНКЦИЯ generateGmailVariations() ---
    function generateGmailVariations() {
      let email = document.getElementById("emailInput").value.trim().toLowerCase();
      const output = document.getElementById("gmailOutput");
      const counter = document.getElementById("emailCounter");
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      output.value = "";
      
      // Автоматически добавляем @gmail.com, если это только логин
      if (email && !email.includes('@')) {
          email = email + "@gmail.com";
      }
      
      const localPart = email.split("@")[0];
      
      // Повторная валидация, но уже с полным адресом (на случай, если пользователь ввел логин)
      const fullEmailRegex = /^([a-z0-9]+(\.?[a-z0-9]+)*)@(gmail|googlemail)\.com$/;
      const isValid = fullEmailRegex.test(email) && localPart.length >= 6 && /^(?!\.).*(?<!\.)$/.test(localPart) && !localPart.includes("..");
      
      if (!isValid) {
        validateEmail();
        counter.innerText = t.emailCounter + "0";
        return;
      }

      const local = email.split("@")[0].replace(/\./g, ''); 
      const variations = new Set();
      const positions = [];

      for (let i = 1; i < local.length; i++) positions.push(i);

      const totalCombos = Math.pow(2, positions.length);

      for (let i = 0; i < totalCombos; i++) {
        let parts = [], last = 0;
        for (let j = 0; j < positions.length; j++) {
          if (i & (1 << j)) {
            parts.push(local.slice(last, positions[j]));
            last = positions[j];
          }
        }
        parts.push(local.slice(last));
        const dotted = parts.join(".");
        
        // Повторная проверка правил точек (должно быть лишним после проверки выше, но для надежности)
        if (dotted.length >= 6 && /^(?!\.).*(?<!\.)$/.test(dotted) && !dotted.includes("..")) {
          variations.add(dotted + "@gmail.com");
          variations.add(dotted + "@googlemail.com");
        }
      }

      const variationList = Array.from(variations).sort();
      output.value = variationList.join("\n");
      counter.innerText = t.emailCounter + variationList.length;
    }
    // --- КОНЕЦ ИЗМЕНЕННОЙ ФУНКЦИИ generateGmailVariations() ---

    function copyGmail() {
      const text = document.getElementById("gmailOutput").value;
      copyToClipboard(text);
    }

    function downloadTextFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-utf-8' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function downloadGmail() {
      const text = document.getElementById("gmailOutput").value;
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      if (!text.trim()) {
        alert(t.noGmailDataError);
        return;
      }
      downloadTextFile("gmail_variations.txt", text);
    }

    function downloadCSV() {
      const text = document.getElementById("gmailOutput").value;
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      if (!text.trim()) {
        alert(t.noGmailExportError);
        return;
      }
      const lines = text.split('\n').filter(Boolean);
      const csvContent = "data:text/csv;charset=utf-8," 
                        + "Email Variation\n" 
                        + lines.map(line => `"${line}"`).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "gmail_variations.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ИЗМЕНЕНА: очищает поле короткой ссылки
    function convertDriveLink() {
      const input = document.getElementById("driveInput").value.trim();
      const output = document.getElementById("driveOutput");
      const shortDisplay = document.getElementById("driveOutputDisplay"); 
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      
      // Очищаем и скрываем короткую ссылку при новом преобразовании
      shortDisplay.innerText = ""; 
      shortDisplay.style.display = "none"; 
      
      const match = input.match(/(?:\/d\/|id=|\/file\/d\/|drive\.google\.com\/(?:file\/d\/|open\?id=))([a-zA-Z0-9_-]{10,})/);
      if (match && match[1]) {
        const fileId = match[1];
        output.value = `https://drive.google.com/uc?export=download&id=${fileId}`;
      } else {
        output.value = "";
        alert(t.invalidDriveLinkError);
      }
    }

    // ИЗМЕНЕНА: Приоритет копирования короткой ссылки, если она есть
    function copyDrive() {
      const shortLink = document.getElementById("driveOutputDisplay").innerText.trim(); // Проверяем короткую
      const convertedLink = document.getElementById("driveOutput").value; // Проверяем преобразованную
      const textToCopy = shortLink || convertedLink;
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      
      if (!textToCopy.trim()) {
        alert(t.noDriveLinkError);
        return;
      }
      copyToClipboard(textToCopy);
    }

    // ИЗМЕНЕНА: Приоритет перехода по короткой ссылке, если она есть
    function goToDriveLink() {
      const shortLink = document.getElementById("driveOutputDisplay").innerText.trim();
      const convertedLink = document.getElementById("driveOutput").value.trim();
      const link = shortLink || convertedLink;
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      if (link) {
        window.open(link, '_blank');
      } else {
        alert(t.noDriveLinkError);
      }
    }
    
    // ФУНКЦИЯ ДЛЯ УКОРАЧИВАНИЯ ССЫЛКИ С ИСПОЛЬЗОВАНИЕМ is.gd
    async function shortenLink(longUrl, outputElementId, customId = null) {
      // outputElementId может быть "driveOutputDisplay" (div) или "shortenerOutputDisplay" (div)
      const outputElement = document.getElementById(outputElementId);
      const lang = document.documentElement.lang || 'uk';
      const t = translations[lang];
      
      if (!longUrl) {
          alert(t.noLinkToShortenError); // Используем общую ошибку для Drive
          return;
      }
      
      let apiEndpoint = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`;
      
      // Добавляем кастомный ID, если он есть
      if (customId) {
          apiEndpoint += `&shorturl=${encodeURIComponent(customId)}`;
      }

      try {
        const response = await fetch(apiEndpoint);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.shorturl) {
          // Общая логика для вывода в div
          outputElement.innerText = data.shorturl;
          outputElement.style.display = "block";
        } else if (data.error) {
          throw new Error(data.error);
        } else {
          throw new Error("Неизвестный ответ от сервиса укорачивания.");
        }
      } catch (error) {
        // Для Drive используем специфичную ошибку
        const errorMessage = (outputElementId === "driveOutputDisplay" || outputElementId === "driveOutput")
                           ? t.shortenLinkError 
                           : t.shortenGeneralError;
        alert(`${errorMessage} ${error.message || ""}`); 
        // Скрываем поле вывода, если произошла ошибка
        outputElement.style.display = "none";
        outputElement.innerText = "";
      }
    }
    
    // ИЗМЕНЕНА: Логика получения ссылки и вывода в новый div
    async function shortenDriveLink() {
      // 1. Приоритет берем из преобразованной ссылки (Drive Output)
      const convertedLink = document.getElementById("driveOutput").value.trim();
      // 2. Если преобразованной нет, берем из основного поля ввода (Drive Input)
      const inputLink = document.getElementById("driveInput").value.trim();
      
      const urlToShorten = convertedLink || inputLink;
      
      if (!urlToShorten) {
          alert(translations[document.documentElement.lang || 'uk'].noLinkToShortenError);
          return;
      }
      
      // Выводит в новый div driveOutputDisplay
      await shortenLink(urlToShorten, "driveOutputDisplay");
    }

    // НОВАЯ ФУНКЦИЯ: ГЕНЕРАЦИЯ QR-КОДА В МОДАЛЬНОЕ ОКНО
    function generateQrCode(url) {
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];

        if (!url) {
            alert(t.noLinkForQrError);
            return;
        }

        // Базовый URL для API QRCode Monkey с параметром download=false
        // size=300 для хорошего качества
        const qrApiUrl = `https://api.qrcode-monkey.com/qr/custom?data=${encodeURIComponent(url)}&size=300&file=png&download=false`;

        const modal = document.getElementById("qrCodeModal");
        const qrImage = document.getElementById("qrCodeImage");
        
        // Устанавливаем URL изображения в модальное окно
        qrImage.src = qrApiUrl;
        
        // Показываем модальное окно
        modal.style.display = "flex";
    }
    
    // Функция для закрытия модального окна
    function closeModal(event) {
        const modal = document.getElementById("qrCodeModal");
        // Закрываем, только если клик был по крестику или по фону
        if (event.target === modal || event.target.className === "modal-close") {
            modal.style.display = "none";
        }
    }
    
    // Функция для скачивания QR-кода
    function downloadQrCode() {
        const qrImage = document.getElementById("qrCodeImage");
        const imageUrl = qrImage.src;
        
        // Мы используем тот же API, но с параметром download=true для форсирования загрузки
        const downloadUrl = imageUrl.replace("download=false", "download=true");

        // Создаем временную ссылку для скачивания
        const link = document.createElement("a");
        link.href = downloadUrl;
        // Устанавливаем имя файла для скачивания (добавляем .png)
        link.download = 'qrcode.png'; 
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Опционально: можно показать тост об успешном сохранении
        showToast(translations[document.documentElement.lang || 'uk'].copySuccess); 
    }


    // ИЗМЕНЕНА: Приоритет генерации QR-кода для короткой ссылки, если она есть
    function generateDriveQr() {
        const shortLink = document.getElementById("driveOutputDisplay").innerText.trim();
        const convertedLink = document.getElementById("driveOutput").value.trim();
        const link = shortLink || convertedLink;
        
        if (!link) {
            alert(translations[document.documentElement.lang || 'uk'].noLinkForQrError);
            return;
        }
        generateQrCode(link);
    }

    // НОВАЯ ФУНКЦИЯ: ГЕНЕРАЦИЯ QR-КОДА ДЛЯ УКОРОТИТЕЛЯ ССЫЛОК
    function generateShortenerQr() {
        // Предпочитаем брать укороченную ссылку, если она есть
        let link = document.getElementById("shortenerOutputDisplay").innerText.trim();
        
        // Если укороченной ссылки нет, берем длинную ссылку из поля ввода
        if (!link) {
            link = document.getElementById("shortenerInput").value.trim();
        }

        generateQrCode(link);
    }
    
    // ===============================================
    // НОВЫЕ ФУНКЦИИ ДЛЯ ГЕНЕРАТОРА ЛОГИНОВ
    // ===============================================
    
    function validateCountInput() {
        const countInput = document.getElementById("countInput");
        const errorField = document.getElementById("loginCountError");
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        let count = parseInt(countInput.value, 10);
        
        if (isNaN(count) || count < 1 || count > 50) {
            errorField.innerText = t.invalidCountError;
            errorField.style.display = "block";
            // Ограничиваем ввод, но не сбрасываем, чтобы пользователь мог исправить
            if (count < 1) countInput.value = 1;
            if (count > 50) countInput.value = 50;
        } else {
            errorField.style.display = "none";
        }
    }
    
    // ИЗМЕНЕНА: Валидация для type="text"
    function validateLengthInput() {
        const lengthInput = document.getElementById("lengthInput");
        const errorField = document.getElementById("loginLengthError");
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        // Удаляем все, кроме цифр, чтобы разрешить ввод
        let value = lengthInput.value.replace(/\D/g, ''); 
        lengthInput.value = value;
        
        let length = parseInt(value, 10);
        const minLength = 6;
        const maxLength = 20;

        // Валидация:
        if (value === "") {
            // Если поле пустое, не показываем ошибку, но считаем невалидным для генерации
            errorField.style.display = "none";
            return; 
        }

        if (isNaN(length) || length < minLength || length > maxLength) {
            errorField.innerText = t.invalidLengthError;
            errorField.style.display = "block";

            // Коррекция значения, чтобы избежать бесконтрольного роста
            if (length > maxLength) {
                lengthInput.value = maxLength; 
            } else if (length < minLength && value.length >= 1) { 
                // Не сбрасываем, пока пользователь набирает, но предупреждаем
            }
        } else {
            errorField.style.display = "none";
        }
    }
    
    // Вспомогательная функция для получения случайного элемента из массива
    function getRandomItem(array) {
        return array[Math.floor(Math.random() * array.length)];
    }
    
    // ОБНОВЛЕННЫЙ СПИСОК СЛОВ: добавлен юмор, ирония, и "мемные" слова.
    const wordList = [
        // Нейтральные слова, имена и популярные основы
        "quick", "smart", "happy", "lucky", "fresh", "cool", "fire", "ice",
        "star", "sky", "cloud", "sun", "moon", "wave", "peak", "zone", "game",
        "book", "note", "key", "link", "code", "data", "byte", "mega", "pro", "master",
        "max", "neo", "alex", "mila", "leo", "nina", "june", "nova", "power", "speed", 
        "turbo", "logic", "dream", "quest", "elite", "prime", "optic", "delta",
        
        // Смешные/Ироничные/Необычные слова (для юмора)
        "potato", "ninja", "bacon", "fluffy", "shush", "oops", "yikes", "sushi",
        "waffle", "socks", "ghost", "noodle", "zebra", "squid", "troll", "bot",
        "fail", "epic", "weird", "hello", "yolo", "oof", "giga", "hacker", "banana", "pickle"
    ];

    /**
     * Генерирует логины на основе слов из wordList, комбинируя их с цифрами.
     */
    function generateWordBasedLogins() {
        const output = document.getElementById("loginOutput");
        
        // Вызываем валидацию перед генерацией
        validateCountInput();
        validateLengthInput();
        
        const countInput = document.getElementById("countInput");
        const lengthInput = document.getElementById("lengthInput");
        
        const count = parseInt(countInput.value, 10);
        // Используем значение из поля ввода, которое может быть строкой
        let targetLength = parseInt(lengthInput.value, 10); 

        // Проверяем окончательную валидность перед генерацией
        if (isNaN(count) || count < 1 || count > 50 || isNaN(targetLength) || targetLength < 6 || targetLength > 20) {
            output.value = "";
            return;
        }
        
        const digits = '0123456789';
        
        const generatedLogins = new Set();
        let attempts = 0;
        const maxAttempts = count * 100;

        while (generatedLogins.size < count && attempts < maxAttempts) {
            let baseWord = getRandomItem(wordList);
            let login = '';
            
            // Если длина слова уже больше или равна целевой, обрезаем и добавляем 1-2 цифры
            if (baseWord.length >= targetLength - 2) {
                // Берем максимум (targetLength - 1), чтобы осталось место для цифры
                const maxWordLen = Math.min(baseWord.length, targetLength - 2); 
                baseWord = baseWord.substring(0, maxWordLen);
                login = baseWord;
                // Добавляем минимум 2 цифры для уникальности и выполнения минимальной длины
                const numDigits = targetLength - login.length;
                for (let i = 0; i < numDigits; i++) {
                    login += getRandomItem(digits);
                }
            } else {
                // Слово короче целевой длины, заполняем остаток.
                const remainingLength = targetLength - baseWord.length;
                
                // 1. Используем либо второе слово, либо цифры.
                if (remainingLength >= 5 && Math.random() < 0.6) { // 60% шанс на два слова
                    let secondWord = getRandomItem(wordList);
                    let combined = baseWord + secondWord;
                    
                    if (combined.length <= targetLength - 2) {
                        login = combined;
                        const numDigits = targetLength - login.length;
                        for (let i = 0; i < numDigits; i++) {
                             login += getRandomItem(digits);
                        }
                    } else {
                        // Если 2 слова слишком длинные, обрезаем второе и добавляем цифры
                        const remainingSpace = targetLength - baseWord.length - 2; // -2 для мин. 2 цифр
                        const maxSecondWordLen = Math.max(0, remainingSpace);
                        combined = baseWord + secondWord.substring(0, maxSecondWordLen);
                        login = combined;
                        
                        const numDigits = targetLength - login.length;
                        for (let i = 0; i < numDigits; i++) {
                             login += getRandomItem(digits);
                        }
                    }
                } else {
                    // 2. Только одно слово + цифры для оставшейся длины
                    login = baseWord;
                    for (let i = 0; i < remainingLength; i++) {
                        login += getRandomItem(digits);
                    }
                }
            }

            // Финальная проверка длины и уникальности
            login = login.substring(0, targetLength);
            // Убеждаемся, что в логине есть хотя бы одна цифра (для уникальности)
            if (login.length >= 6 && /[0-9]/.test(login)) { 
                generatedLogins.add(login);
            }
            attempts++;
        }
        
        const loginList = Array.from(generatedLogins).sort();
        output.value = loginList.join("\n");
    }

    function copyLogins() {
        const text = document.getElementById("loginOutput").value;
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        if (!text.trim()) {
            alert(t.noLoginsToCopyError);
            return;
        }
        copyToClipboard(text);
    }
    
    // НОВАЯ ФУНКЦИЯ: Скачивание логинов в .txt
    function downloadLoginsTxt() {
        const text = document.getElementById("loginOutput").value;
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        if (!text.trim()) {
            alert(t.noLoginsToSaveError);
            return;
        }
        downloadTextFile("gmail_logins.txt", text);
    }

    
    // ===============================================
    // КОНЕЦ НОВЫХ ФУНКЦИЙ ДЛЯ ГЕНЕРАТОРА ЛОГИНОВ
    // ===============================================

    // ===============================================
    // НОВЫЕ ФУНКЦИИ ДЛЯ УКОРОТИТЕЛЯ ССЫЛОК
    // ===============================================
    
    async function shortenCustomLink() {
        const longUrl = document.getElementById("shortenerInput").value.trim();
        const customId = document.getElementById("customIdInput").value.trim();
        const outputDisplay = document.getElementById("shortenerOutputDisplay");
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        outputDisplay.style.display = "none"; // Скрываем до генерации
        outputDisplay.innerText = ""; // Очищаем текст
        
        if (!longUrl) {
            alert(t.noLinkToShortenGeneralError);
            return;
        }
        
        // Вызывает shortenLink, который теперь умеет работать с div
        await shortenLink(longUrl, "shortenerOutputDisplay", customId); 
    }
    
    function copyShortenedLink() {
        // Копируем текст из нового div
        const text = document.getElementById("shortenerOutputDisplay").innerText; 
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        if (!text.trim()) {
            // Если div пуст, значит, ссылка не была сгенерирована
            alert(t.noLinkToShortenGeneralError); 
            return;
        }
        copyToClipboard(text);
    }

    // ===============================================
    // КОНЕЦ НОВЫХ ФУНКЦИЙ ДЛЯ УКОРОТИТЕЛЯ ССЫЛОК
    // ===============================================

    // ===============================================
    // НОВЫЕ ФУНКЦИИ ДЛЯ M3U ПАРСЕРА
    // ===============================================

    function parseM3UFile() {
        const fileInput = document.getElementById("m3uFileInput");
        const output = document.getElementById("m3uOutput");
        const counter = document.getElementById("m3uCounter");
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];

        output.value = "";
        counter.innerText = t.m3uCounter + "0";

        const file = fileInput.files[0];
        if (!file) {
            return; 
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const lines = content.split('\n');
                const channelNames = new Set();
                
                // Регулярное выражение для извлечения названия канала
                // #EXTINF:-1 group-title="NEWS",Название канала
                // или #EXTINF:-1,Название канала
                const extinfRegex = /#EXTINF:.*,(.+)/;

                lines.forEach(line => {
                    const match = line.match(extinfRegex);
                    if (match && match[1]) {
                        // Очищаем и добавляем название канала
                        let channelName = match[1].trim();
                        if (channelName) {
                           channelNames.add(channelName);
                        }
                    }
                });

                const sortedChannels = Array.from(channelNames).sort((a, b) => {
                    // Используем localeCompare для правильной сортировки строк с учетом локали
                    return a.localeCompare(b, lang, { sensitivity: 'base' });
                });

                if (sortedChannels.length > 0) {
                    output.value = sortedChannels.join("\n");
                    counter.innerText = t.m3uCounter + sortedChannels.length;
                } else {
                    output.value = "";
                    counter.innerText = t.m3uCounter + "0";
                    alert(t.noChannelsFound);
                }

            } catch (error) {
                output.value = "";
                counter.innerText = t.m3uCounter + "0";
                alert(t.m3uReadError + error.message);
            }
        };

        reader.onerror = function() {
            output.value = "";
            counter.innerText = t.m3uCounter + "0";
            alert(t.m3uReadError + reader.error.message);
        };

        // Читаем файл как текст
        reader.readAsText(file);
    }
    
    function copyM3UOutput() {
        const text = document.getElementById("m3uOutput").value;
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        if (!text.trim()) {
            alert(t.noM3UDataError);
            return;
        }
        copyToClipboard(text);
    }

    function downloadM3UOutput() {
        const text = document.getElementById("m3uOutput").value;
        const lang = document.documentElement.lang || 'uk';
        const t = translations[lang];
        
        if (!text.trim()) {
            alert(t.noM3UDataError);
            return;
        }
        // Загружаем в .txt файл
        downloadTextFile("m3u_channels.txt", text);
    }

    // ===============================================
    // КОНЕЦ НОВЫХ ФУНКЦИЙ ДЛЯ M3U ПАРСЕРА
    // ===============================================

  </script>
</body>
</html>